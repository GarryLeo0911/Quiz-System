{% extends 'base.html' %}

{% block title %}Question Bank - Quiz System{% endblock %}

{% block extra_head %}
<script>
    tailwind.config.theme.extend.colors = {
        ...tailwind.config.theme.extend.colors,
        "neutral-text-light": "#0d141b",
        "neutral-text-dark": "#f0f0f0",
        "subtle-text-light": "#4c739a",
        "subtle-text-dark": "#a0a0a0",
        "surface-light": "#ffffff",
        "surface-dark": "#1a242f",
        "border-light": "#cfdbe7",
        "border-dark": "#343f4b",
    };
</script>
{% endblock %}

{% block content %}
<div class="flex h-screen">
    <aside class="flex w-64 flex-col border-r border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark p-4">
        <div class="flex-grow">
            <div class="flex items-center gap-3 p-2 mb-6">
                <span class="material-symbols-outlined text-primary text-3xl">school</span>
                <h1 class="text-xl font-bold">QuizMaster</h1>
            </div>
            <div class="flex flex-col gap-2">
                <a class="flex items-center gap-3 rounded-lg px-3 py-2 hover:bg-primary/10" href="{% url 'dashboard' %}">
                    <span class="material-symbols-outlined text-xl">dashboard</span>
                    <p class="text-sm font-medium">Dashboard</p>
                </a>
                <a class="flex items-center gap-3 rounded-lg px-3 py-2 hover:bg-primary/10" href="{% url 'quiz_list' %}">
                    <span class="material-symbols-outlined text-xl">quiz</span>
                    <p class="text-sm font-medium">Quizzes</p>
                </a>
                <a class="flex items-center gap-3 rounded-lg bg-primary/20 px-3 py-2 text-primary" href="{% url 'question_bank' %}">
                    <span class="material-symbols-outlined text-xl font-bold">help_center</span>
                    <p class="text-sm font-bold">Questions</p>
                </a>
            </div>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto p-8">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                <div class="flex flex-col gap-1">
                    <p class="text-3xl font-black tracking-tight">Question Bank</p>
                    <p class="text-subtle-text-light dark:text-subtle-text-dark">Create, edit, and organize all your quiz questions.</p>
                </div>
                <a href="{% url 'question_create' %}" class="flex items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold shadow-sm hover:bg-primary/90">
                    <span class="material-symbols-outlined text-lg">add_circle</span>
                    <span class="truncate">Add New Question</span>
                </a>
            </div>

            <div class="flex gap-8">
                <aside class="w-64 flex-shrink-0">
                    <div class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-border-light dark:border-border-dark">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="font-bold text-lg">Groups</h2>
                            <button onclick="showAddCategoryModal()" class="flex items-center justify-center gap-1 rounded-md text-primary text-sm font-medium hover:bg-primary/10 p-1">
                                <span class="material-symbols-outlined text-lg">add</span>
                                <span>New</span>
                            </button>
                        </div>
                        <div class="flex flex-col gap-1">
                            <a class="flex items-center justify-between rounded-lg px-3 py-2 {% if not request.GET.category %}bg-primary/20 text-primary{% else %}hover:bg-primary/10{% endif %}" href="{% url 'question_bank' %}">
                                <span class="font-medium text-sm">All Questions</span>
                                <span class="text-xs {% if not request.GET.category %}bg-primary/20 text-primary{% else %}bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300{% endif %} font-semibold rounded-full size-5 flex items-center justify-center">{{ questions|length }}</span>
                            </a>
                            {% for category in categories %}
                            <a class="group flex items-center justify-between rounded-lg px-3 py-2 {% if request.GET.category == category.id %}bg-primary/20 text-primary{% else %}hover:bg-primary/10{% endif %}" href="?category={{ category.id }}">
                                <span class="font-medium text-sm">{{ category.name }}</span>
                                <div class="flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="event.preventDefault(); deleteCategory('{{ category.id }}')" class="p-1 rounded-md hover:bg-red-500/20 text-red-500">
                                        <span class="material-symbols-outlined text-base">delete</span>
                                    </button>
                                </div>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </aside>

                <div class="flex-1 min-w-0">
                    <div class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-border-light dark:border-border-dark mb-6">
                        <form method="GET" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-1">
                                <label class="flex w-full flex-1 items-stretch rounded-lg h-12 bg-background-light dark:bg-background-dark">
                                    <div class="text-subtle-text-light dark:text-subtle-text-dark flex items-center justify-center pl-4">
                                        <span class="material-symbols-outlined">search</span>
                                    </div>
                                    <input name="search" value="{{ request.GET.search }}" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden text-neutral-text-light dark:text-neutral-text-dark focus:outline-0 focus:ring-0 border-none bg-transparent h-full placeholder:text-subtle-text-light dark:placeholder:text-subtle-text-dark px-2 text-base font-normal" placeholder="Search by keyword..."/>
                                </label>
                            </div>
                            <div class="md:col-span-1">
                                <select name="type" class="form-select flex h-12 w-full shrink-0 items-center justify-between gap-x-2 rounded-lg bg-background-light dark:bg-background-dark px-4 text-left border-none focus:outline-0 focus:ring-0">
                                    <option value="">All Types</option>
                                    <option value="single_choice" {% if request.GET.type == 'single_choice' %}selected{% endif %}>Single Choice</option>
                                    <option value="multiple_choice" {% if request.GET.type == 'multiple_choice' %}selected{% endif %}>Multiple Choice</option>
                                    <option value="matching" {% if request.GET.type == 'matching' %}selected{% endif %}>Matching</option>
                                </select>
                            </div>
                            <div class="md:col-span-1">
                                <button type="submit" class="w-full h-12 bg-primary text-white rounded-lg font-bold hover:bg-primary/90">Search</button>
                            </div>
                        </form>
                    </div>

                    <div class="overflow-hidden rounded-xl border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-background-light dark:bg-background-dark">
                                    <tr>
                                        <th class="px-4 py-3 text-sm font-medium">Question Text</th>
                                        <th class="px-4 py-3 text-sm font-medium w-48">Type</th>
                                        <th class="px-4 py-3 text-sm font-medium w-48">Group</th>
                                        <th class="px-4 py-3 text-sm font-medium w-48">Date Created</th>
                                        <th class="px-4 py-3 text-sm font-medium w-32 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for question in questions %}
                                    <tr class="border-t border-border-light dark:border-border-dark hover:bg-primary/5">
                                        <td class="px-4 py-3 text-sm">{{ question.question_text|truncatewords:15 }}</td>
                                        <td class="px-4 py-3 text-sm">
                                            {% if question.question_type == 'single_choice' %}
                                            <span class="inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-900/50 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-300 ring-1 ring-inset ring-blue-600/20 dark:ring-blue-500/30">Single Choice</span>
                                            {% elif question.question_type == 'multiple_choice' %}
                                            <span class="inline-flex items-center rounded-md bg-purple-50 dark:bg-purple-900/50 px-2 py-1 text-xs font-medium text-purple-700 dark:text-purple-300 ring-1 ring-inset ring-purple-600/20 dark:ring-purple-500/30">Multiple Choice</span>
                                            {% elif question.question_type == 'matching' %}
                                            <span class="inline-flex items-center rounded-md bg-green-50 dark:bg-green-900/50 px-2 py-1 text-xs font-medium text-green-700 dark:text-green-300 ring-1 ring-inset ring-green-600/20 dark:ring-green-500/30">Matching</span>
                                            {% endif %}
                                        </td>
                                        <td class="px-4 py-3 text-sm text-subtle-text-light dark:text-subtle-text-dark">
                                            {% for cat in categories %}
                                                {% if cat.id == question.category_id %}{{ cat.name }}{% endif %}
                                            {% endfor %}
                                        </td>
                                        <td class="px-4 py-3 text-sm text-subtle-text-light dark:text-subtle-text-dark">{{ question.created_at|date:"M d, Y" }}</td>
                                        <td class="px-4 py-3 text-center">
                                            <div class="flex justify-center gap-2">
                                                <a href="{% url 'question_edit' question.id %}" class="p-1 rounded-md hover:bg-primary/20">
                                                    <span class="material-symbols-outlined text-xl">edit</span>
                                                </a>
                                                <button onclick="deleteQuestion('{{ question.id }}')" class="p-1 rounded-md hover:bg-red-500/20 text-red-500">
                                                    <span class="material-symbols-outlined text-xl">delete</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="px-4 py-8 text-center text-subtle-text-light dark:text-subtle-text-dark">
                                            No questions found. <a href="{% url 'question_create' %}" class="text-primary font-bold hover:underline">Create your first question</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="flex flex-wrap items-center justify-between gap-4 p-4 border-t border-border-light dark:border-border-dark">
                            <div class="text-sm text-subtle-text-light dark:text-subtle-text-dark">
                                Showing {{ questions|length }} question{{ questions|length|pluralize }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function deleteQuestion(questionId) {
        if (confirm('Are you sure you want to delete this question?')) {
            fetch(`/questions/${questionId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error deleting question');
                }
            });
        }
    }

    function deleteCategory(categoryId) {
        if (confirm('Are you sure you want to delete this category?')) {
            fetch(`/api/categories/${categoryId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error deleting category');
                }
            });
        }
    }

    function showAddCategoryModal() {
        const name = prompt('Enter category name:');
        if (name) {
            fetch('/api/categories/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error creating category');
                }
            });
        }
    }
</script>
{% endblock %}
