{% extends 'base.html' %}
{% load static %}

{% block title %}Exam Results - {{ quiz.title }}{% endblock %}

{% block extra_head %}
<script>
    tailwind.config.theme.extend.colors = {
        ...tailwind.config.theme.extend.colors,
        "success": "#28a745",
        "danger": "#dc3545",
        "text-light": "#0d141b",
        "text-dark": "#f0f2f4",
        "border-light": "#e7edf3",
        "border-dark": "#2a374a",
        "surface-light": "#ffffff",
        "surface-dark": "#192734"
    };
</script>
<style>
    .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
</style>
{% endblock %}

{% block content %}
<div class="relative flex h-auto min-h-screen w-full flex-col">
    <div class="layout-container flex h-full grow flex-col">
        <div class="flex flex-1 justify-center p-4 sm:p-6 md:p-8">
            <div class="layout-content-container flex w-full max-w-5xl flex-1 flex-col gap-6">
                <!-- TopNavBar -->
                <header class="flex items-center justify-between whitespace-nowrap border-b border-border-light dark:border-border-dark px-4 py-3 sm:px-6">
                    <div class="flex items-center gap-4">
                        <div class="text-primary text-2xl">
                            <span class="material-symbols-outlined !text-4xl">quiz</span>
                        </div>
                        <h2 class="text-lg font-bold leading-tight tracking-[-0.015em] sm:text-xl">Quiz System</h2>
                    </div>
                    <div class="flex flex-1 items-center justify-end gap-4 sm:gap-6">
                        <a class="hidden text-sm font-medium leading-normal sm:block" href="{% url 'dashboard' %}">Dashboard</a>
                        <button onclick="window.print()" class="flex min-w-[84px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">
                            <span class="material-symbols-outlined">print</span>
                            <span class="truncate">Print Results</span>
                        </button>
                    </div>
                </header>
                
                <!-- PageHeading -->
                <div class="flex flex-wrap justify-between gap-4 px-4 sm:px-6 pt-4">
                    <div class="flex min-w-72 flex-col gap-2">
                        <p class="text-3xl font-black leading-tight tracking-[-0.033em] md:text-4xl">Exam Results: {{ quiz.title }}</p>
                        <p class="text-text-light/70 dark:text-text-dark/70 text-base font-normal leading-normal">Completed on {{ attempt.completed_at|date:"d F Y" }}</p>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="grid grid-cols-1 gap-4 px-4 sm:grid-cols-2 md:grid-cols-3 sm:px-6">
                    <div class="flex flex-col gap-2 rounded-lg p-6 border bg-surface-light dark:bg-surface-dark border-border-light dark:border-border-dark">
                        <p class="text-base font-medium leading-normal">Final Score</p>
                        <p class="tracking-light text-3xl font-bold leading-tight text-primary">{{ attempt.score }}%</p>
                    </div>
                    <div class="flex flex-col gap-2 rounded-lg p-6 border bg-surface-light dark:bg-surface-dark border-border-light dark:border-border-dark">
                        <p class="text-base font-medium leading-normal">Correct Answers</p>
                        <p class="tracking-light text-3xl font-bold leading-tight">{{ correct_count }}/{{ total_questions }}</p>
                    </div>
                    <div class="flex flex-col gap-2 rounded-lg p-6 border bg-surface-light dark:bg-surface-dark border-border-light dark:border-border-dark">
                        <p class="text-base font-medium leading-normal">Time Taken</p>
                        <p class="tracking-light text-3xl font-bold leading-tight">{{ attempt.time_taken }}</p>
                    </div>
                </div>
                
                <!-- SectionHeader and Chips -->
                <div class="px-4 sm:px-6 pt-6">
                    <h2 class="text-2xl font-bold leading-tight tracking-[-0.015em] pb-4">Detailed Review</h2>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="filterQuestions('all')" class="filter-btn flex h-9 shrink-0 cursor-pointer items-center justify-center gap-x-2 rounded-full px-4 bg-primary text-white">
                            <p class="text-sm font-medium leading-normal">All Questions ({{ total_questions }})</p>
                        </button>
                        <button onclick="filterQuestions('correct')" class="filter-btn flex h-9 shrink-0 cursor-pointer items-center justify-center gap-x-2 rounded-full px-4 bg-background-light dark:bg-surface-dark border border-border-light dark:border-border-dark hover:bg-border-light dark:hover:bg-border-dark/50 transition-colors">
                            <p class="text-sm font-medium leading-normal">Correct ({{ correct_count }})</p>
                        </button>
                        <button onclick="filterQuestions('incorrect')" class="filter-btn flex h-9 shrink-0 cursor-pointer items-center justify-center gap-x-2 rounded-full px-4 bg-background-light dark:bg-surface-dark border border-border-light dark:border-border-dark hover:bg-border-light dark:hover:bg-border-dark/50 transition-colors">
                            <p class="text-sm font-medium leading-normal">Incorrect ({{ total_questions|add:"-"|add:correct_count }})</p>
                        </button>
                    </div>
                </div>
                
                <!-- Question List -->
                <div class="flex flex-col gap-4 px-4 sm:px-6 pb-8">
                    {% for answer in answers %}
                    <div class="question-card bg-white dark:bg-slate-900/50 rounded-xl border-2 {% if answer.is_correct %}border-success{% else %}border-danger{% endif %} p-8 shadow-sm" data-correct="{{ answer.is_correct|lower }}">
                        <!-- Question Header with Score Badge -->
                        <div class="flex items-start justify-between gap-4 mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h2 class="text-slate-900 dark:text-white tracking-tight text-xl font-bold">
                                        Question {{ forloop.counter }}
                                    </h2>
                                    <div class="flex items-center gap-2 px-3 py-1 rounded-full {% if answer.is_correct %}bg-success{% else %}bg-danger{% endif %} text-white">
                                        <span class="material-symbols-outlined !text-base">{% if answer.is_correct %}check_circle{% else %}cancel{% endif %}</span>
                                        <span class="text-sm font-bold">{{ answer.points_earned }} / {{ answer.question.points }} pts</span>
                                    </div>
                                </div>
                                <p class="text-slate-600 dark:text-slate-300 text-base font-normal leading-relaxed">
                                    {{ answer.question.question_text }}
                                </p>
                            </div>
                        </div>
                        
                        {% if answer.question.image %}
                        <div class="mt-4 mb-6">
                            <img src="/media/{{ answer.question.image }}" alt="Question image" class="max-w-full rounded-lg border border-slate-200 dark:border-slate-800">
                        </div>
                        {% endif %}
                        
                        <!-- Answer Options with Indicators -->
                        <div class="mt-6">
                            {% if answer.question.question_type == 'single_choice' %}
                            <!-- Single Choice Options -->
                            <div class="flex flex-col gap-3">
                                {% for choice in answer.question.choices %}
                                <div class="flex items-center gap-4 rounded-lg border-2 p-4 
                                    {% if choice.is_correct %}border-success bg-success/10{% elif choice.id in answer.user_answer_ids %}border-danger bg-danger/10{% else %}border-slate-200 dark:border-slate-700{% endif %}">
                                    <!-- Radio Button (disabled) -->
                                    <div class="relative flex items-center justify-center h-5 w-5 flex-shrink-0">
                                        <input type="radio" 
                                               disabled 
                                               {% if choice.id in answer.user_answer_ids %}checked{% endif %}
                                               class="h-5 w-5 appearance-none rounded-full border-2 border-slate-300 dark:border-slate-600 checked:border-primary checked:bg-[image:url('data:image/svg+xml,%3csvg_viewBox=%270_0_16_16%27_fill=%27rgb(19,127,236)%27_xmlns=%27http://www.w3.org/2000/svg%27%3e%3ccircle_cx=%278%27_cy=%278%27_r=%273%27/%3e%3c/svg%3e')]"/>
                                    </div>
                                    
                                    <!-- Choice Text -->
                                    <span class="flex-1 text-slate-700 dark:text-slate-200 text-base font-normal leading-normal">
                                        {{ choice.option_text }}
                                    </span>
                                    
                                    <!-- Indicator Icons -->
                                    {% if choice.is_correct %}
                                    <span class="material-symbols-outlined text-success">check_circle</span>
                                    {% elif choice.id in answer.user_answer_ids %}
                                    <span class="material-symbols-outlined text-danger">cancel</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            
                            {% elif answer.question.question_type == 'multiple_choice' %}
                            <!-- Multiple Choice Options -->
                            <div class="flex flex-col gap-3">
                                {% for choice in answer.question.choices %}
                                <div class="flex items-center gap-4 rounded-lg border-2 p-4 
                                    {% if choice.is_correct and choice.id in answer.user_answer_ids %}border-success bg-success/10{% elif choice.is_correct %}border-success/50 bg-success/5{% elif choice.id in answer.user_answer_ids %}border-danger bg-danger/10{% else %}border-slate-200 dark:border-slate-700{% endif %}">
                                    <!-- Checkbox (disabled) -->
                                    <div class="relative flex items-center justify-center h-5 w-5 flex-shrink-0">
                                        <input type="checkbox" 
                                               disabled 
                                               {% if choice.id in answer.user_answer_ids %}checked{% endif %}
                                               class="h-5 w-5 appearance-none rounded border-2 border-slate-300 dark:border-slate-600 checked:border-primary checked:bg-primary checked:bg-[image:url('data:image/svg+xml,%3csvg_viewBox=%270_0_16_16%27_fill=%27white%27_xmlns=%27http://www.w3.org/2000/svg%27%3e%3cpath_d=%27M12.207_4.793a1_1_0_010_1.414l-5_5a1_1_0_01-1.414_0l-2-2a1_1_0_011.414-1.414L6.5_9.086l4.293-4.293a1_1_0_011.414_0z%27/%3e%3c/svg%3e')]"/>
                                    </div>
                                    
                                    <!-- Choice Text -->
                                    <span class="flex-1 text-slate-700 dark:text-slate-200 text-base font-normal leading-normal">
                                        {{ choice.option_text }}
                                    </span>
                                    
                                    <!-- Indicator Icons -->
                                    {% if choice.is_correct and choice.id in answer.user_answer_ids %}
                                    <span class="material-symbols-outlined text-success">check_circle</span>
                                    {% elif choice.is_correct %}
                                    <span class="material-symbols-outlined text-success">radio_button_unchecked</span>
                                    {% elif choice.id in answer.user_answer_ids %}
                                    <span class="material-symbols-outlined text-danger">cancel</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            
                            {% elif answer.question.question_type == 'true_false' %}
                            <!-- True/False Options -->
                            <div class="flex flex-col gap-3">
                                {% with user_answer_lower=answer.user_answer|lower correct_answer_lower=answer.question.correct_answer|lower %}
                                <div class="flex items-center gap-4 rounded-lg border-2 p-4 
                                    {% if correct_answer_lower == 'true' %}border-success bg-success/10{% elif user_answer_lower == 'true' %}border-danger bg-danger/10{% else %}border-slate-200 dark:border-slate-700{% endif %}">
                                    <input type="radio" disabled {% if user_answer_lower == 'true' %}checked{% endif %} class="h-5 w-5"/>
                                    <span class="flex-1 text-slate-700 dark:text-slate-200 text-base font-normal">True</span>
                                    {% if correct_answer_lower == 'true' %}
                                    <span class="material-symbols-outlined text-success">check_circle</span>
                                    {% elif user_answer_lower == 'true' %}
                                    <span class="material-symbols-outlined text-danger">cancel</span>
                                    {% endif %}
                                </div>
                                <div class="flex items-center gap-4 rounded-lg border-2 p-4 
                                    {% if correct_answer_lower == 'false' %}border-success bg-success/10{% elif user_answer_lower == 'false' %}border-danger bg-danger/10{% else %}border-slate-200 dark:border-slate-700{% endif %}">
                                    <input type="radio" disabled {% if user_answer_lower == 'false' %}checked{% endif %} class="h-5 w-5"/>
                                    <span class="flex-1 text-slate-700 dark:text-slate-200 text-base font-normal">False</span>
                                    {% if correct_answer_lower == 'false' %}
                                    <span class="material-symbols-outlined text-success">check_circle</span>
                                    {% elif user_answer_lower == 'false' %}
                                    <span class="material-symbols-outlined text-danger">cancel</span>
                                    {% endif %}
                                </div>
                                {% endwith %}
                            </div>
                            
                            {% elif answer.question.question_type == 'matching' %}
                            <!-- Matching Question -->
                            <div class="flex flex-col gap-3">
                                {% for pair in answer.question.matching_pairs %}
                                <div class="flex items-center gap-4 rounded-lg border-2 p-4 
                                    {% if forloop.counter0|add:0 < answer.user_matching|length and answer.user_matching|slice:forloop.counter0|first == pair.correct_match %}border-success bg-success/10{% else %}border-danger bg-danger/10{% endif %}">
                                    <span class="text-slate-900 dark:text-white font-medium w-1/3">{{ pair.left_item }}</span>
                                    <span class="material-symbols-outlined text-slate-400">arrow_forward</span>
                                    <div class="flex-1 px-4 py-2 rounded-md border-2 border-slate-300 dark:border-slate-600 bg-slate-100 dark:bg-slate-800">
                                        {% if forloop.counter0 < answer.user_matching|length %}
                                            {% with user_idx=answer.user_matching|slice:forloop.counter0|first %}
                                                {% if user_idx < answer.question.matching_definitions|length %}
                                                    {{ answer.question.matching_definitions|slice:user_idx|first }}
                                                {% endif %}
                                            {% endwith %}
                                        {% else %}
                                            Not answered
                                        {% endif %}
                                    </div>
                                    {% if forloop.counter0 < answer.user_matching|length and answer.user_matching|slice:forloop.counter0|first == pair.correct_match %}
                                    <span class="material-symbols-outlined text-success">check_circle</span>
                                    {% else %}
                                    <div class="flex items-center gap-2">
                                        <span class="material-symbols-outlined text-danger">cancel</span>
                                        <span class="text-sm text-success whitespace-nowrap">(Correct: {{ answer.question.matching_definitions|slice:pair.correct_match|first }})</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            
                            {% elif answer.question.question_type == 'short_answer' %}
                            <!-- Short Answer -->
                            <div class="flex flex-col gap-3">
                                <div class="rounded-lg border-2 {% if answer.is_correct %}border-success bg-success/10{% else %}border-danger bg-danger/10{% endif %} p-4">
                                    <p class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Your Answer:</p>
                                    <p class="text-base text-slate-900 dark:text-white">{{ answer.user_answer }}</p>
                                </div>
                                {% if not answer.is_correct %}
                                <div class="rounded-lg border-2 border-success bg-success/10 p-4">
                                    <p class="text-sm font-medium text-success mb-2">Correct Answer:</p>
                                    <p class="text-base text-success">{{ answer.correct_answer }}</p>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Explanation -->
                        {% if answer.question.explanation %}
                        <div class="flex items-start gap-3 rounded-lg border border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-900/20 p-4 mt-6">
                            <span class="material-symbols-outlined text-blue-600 dark:text-blue-400 text-lg mt-0.5">info</span>
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-blue-800 dark:text-blue-300 mb-1">Explanation</p>
                                <p class="text-sm text-blue-700 dark:text-blue-400 leading-relaxed">{{ answer.question.explanation }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Actions -->
                <div class="flex flex-wrap gap-4 px-4 sm:px-6 pb-8">
                    <a href="{% url 'quiz_take' quiz.id %}" class="flex min-w-[84px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90">
                        <span class="material-symbols-outlined">refresh</span>
                        <span class="truncate">Retake Quiz</span>
                    </a>
                    <a href="{% url 'quiz_list' %}" class="flex min-w-[84px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-background-light dark:bg-surface-dark border border-border-light dark:border-border-dark text-text-light dark:text-text-dark text-sm font-bold leading-normal tracking-[0.015em] hover:bg-border-light dark:hover:bg-border-dark/50">
                        <span class="truncate">Back to Quizzes</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function filterQuestions(filter) {
        const cards = document.querySelectorAll('.question-card');
        const buttons = document.querySelectorAll('.filter-btn');
        
        // Update button states
        buttons.forEach(btn => {
            btn.classList.remove('bg-primary', 'text-white');
            btn.classList.add('bg-background-light', 'dark:bg-surface-dark', 'border', 'border-border-light', 'dark:border-border-dark');
        });
        event.target.closest('button').classList.remove('bg-background-light', 'dark:bg-surface-dark', 'border', 'border-border-light', 'dark:border-border-dark');
        event.target.closest('button').classList.add('bg-primary', 'text-white');
        
        // Filter cards
        cards.forEach(card => {
            const isCorrect = card.dataset.correct === 'true';
            
            if (filter === 'all') {
                card.style.display = 'flex';
            } else if (filter === 'correct' && isCorrect) {
                card.style.display = 'flex';
            } else if (filter === 'incorrect' && !isCorrect) {
                card.style.display = 'flex';
            } else {
                card.style.display = 'none';
            }
        });
    }
</script>
{% endblock %}
