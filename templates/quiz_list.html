{% extends 'base.html' %}

{% block title %}Quizzes - Quiz System{% endblock %}

{% block content %}
<div class="flex h-screen w-full flex-col">
    <!-- TopNavBar -->
    <header class="flex shrink-0 items-center justify-between whitespace-nowrap border-b border-solid border-[#e7edf3] dark:border-slate-700 bg-white dark:bg-background-dark px-6 py-3">
        <div class="flex items-center gap-4 text-[#0d141b] dark:text-white">
            <div class="text-primary size-6">
                <svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                    <path d="M44 4H30.6666V17.3334H17.3334V30.6666H4V44H44V4Z" fill="currentColor"></path>
                </svg>
            </div>
            <h2 class="text-[#0d141b] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Quiz System</h2>
        </div>
        <div class="flex flex-1 justify-center gap-8">
            <div class="flex items-center gap-9">
                <a class="text-[#0d141b] dark:text-slate-300 text-sm font-medium leading-normal" href="{% url 'dashboard' %}">Dashboard</a>
                <a class="text-primary dark:text-primary text-sm font-bold leading-normal" href="{% url 'quiz_list' %}">Exams</a>
                <a class="text-[#0d141b] dark:text-slate-300 text-sm font-medium leading-normal" href="{% url 'question_bank' %}">Question Bank</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-8">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                <div class="flex flex-col gap-1">
                    <p class="text-3xl font-black tracking-tight">My Quizzes</p>
                    <p class="text-slate-500">Manage and create your exam collections</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="showGenerateModal()" class="flex items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-purple-600 text-white text-sm font-bold shadow-sm hover:bg-purple-700">
                        <span class="material-symbols-outlined text-lg">auto_awesome</span>
                        <span>Auto Generate</span>
                    </button>
                    <a href="{% url 'quiz_create' %}" class="flex items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold shadow-sm hover:bg-primary/90">
                        <span class="material-symbols-outlined text-lg">add_circle</span>
                        <span>Create New Quiz</span>
                    </a>
                </div>
            </div>

            <!-- Quizzes Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for quiz in quizzes %}
                <div class="bg-white dark:bg-slate-900 rounded-xl border border-[#e7edf3] dark:border-slate-700 p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-start justify-between mb-4">
                        <h3 class="text-xl font-bold">{{ quiz.title }}</h3>
                        {% if quiz.is_published %}
                        <span class="inline-flex items-center rounded-full bg-green-100 dark:bg-green-900/30 px-3 py-1 text-xs font-medium text-green-700 dark:text-green-400">Published</span>
                        {% else %}
                        <span class="inline-flex items-center rounded-full bg-amber-100 dark:bg-amber-900/30 px-3 py-1 text-xs font-medium text-amber-700 dark:text-amber-400">Draft</span>
                        {% endif %}
                    </div>
                    
                    <p class="text-slate-600 dark:text-slate-400 text-sm mb-4">{{ quiz.description|truncatewords:20 }}</p>
                    
                    <div class="flex items-center gap-4 text-sm text-slate-500 dark:text-slate-400 mb-6">
                        <div class="flex items-center gap-1">
                            <span class="material-symbols-outlined text-lg">quiz</span>
                            <span>{{ quiz.questions|length }} Questions</span>
                        </div>
                        {% if quiz.time_limit %}
                        <div class="flex items-center gap-1">
                            <span class="material-symbols-outlined text-lg">schedule</span>
                            <span>{{ quiz.time_limit }} min</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="flex gap-2">
                        <a href="{% url 'quiz_take' quiz.id %}" class="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-primary text-white rounded-lg font-bold hover:bg-primary/90">
                            <span class="material-symbols-outlined text-sm">play_arrow</span>
                            <span>Take Quiz</span>
                        </a>
                        <a href="{% url 'quiz_edit' quiz.id %}" class="flex items-center justify-center p-2 bg-slate-100 dark:bg-slate-800 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                            <span class="material-symbols-outlined">edit</span>
                        </a>
                        <button onclick="deleteQuiz('{{ quiz.id }}')" class="flex items-center justify-center p-2 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/50">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-full flex flex-col items-center justify-center py-16 text-center">
                    <span class="material-symbols-outlined text-6xl text-slate-400 mb-4">quiz</span>
                    <p class="text-xl font-bold text-slate-700 dark:text-slate-300 mb-2">No quizzes yet</p>
                    <p class="text-slate-500 mb-6">Create your first quiz to get started</p>
                    <a href="{% url 'quiz_create' %}" class="flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-lg font-bold hover:bg-primary/90">
                        <span class="material-symbols-outlined">add</span>
                        <span>Create Your First Quiz</span>
                    </a>
                </div>
                {% endfor %}
            </div>
                </div>
    </main>
</div>

<!-- Auto Generate Modal -->
<div id="generateModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-md w-full border border-slate-200 dark:border-slate-700">
        <div class="p-6 border-b border-slate-200 dark:border-slate-700">
            <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Auto Generate Quiz</h2>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Automatically create quizzes from your question bank</p>
        </div>
        
        <div class="p-6 space-y-6">
            <!-- Generation Type -->
            <div>
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3">Generation Method</label>
                <div class="space-y-3">
                    <label class="flex items-start gap-3 p-4 border-2 border-slate-200 dark:border-slate-700 rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800/50 has-[:checked]:border-primary has-[:checked]:bg-primary/5">
                        <input type="radio" name="generation_type" value="random" checked class="mt-1 h-4 w-4 text-primary">
                        <div>
                            <p class="font-semibold text-slate-900 dark:text-white">Random Selection</p>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Select 50 questions randomly from all questions</p>
                        </div>
                    </label>
                    <label class="flex items-start gap-3 p-4 border-2 border-slate-200 dark:border-slate-700 rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800/50 has-[:checked]:border-primary has-[:checked]:bg-primary/5">
                        <input type="radio" name="generation_type" value="category" class="mt-1 h-4 w-4 text-primary">
                        <div>
                            <p class="font-semibold text-slate-900 dark:text-white">Category Balanced</p>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Select 5 questions from each category</p>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Quiz Title -->
            <div>
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Quiz Title</label>
                <input type="text" id="quiz-title" placeholder="e.g., Auto-Generated Quiz" class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary">
            </div>
        </div>
        
        <div class="p-6 bg-slate-50 dark:bg-slate-800/50 rounded-b-2xl flex gap-3">
            <button onclick="hideGenerateModal()" class="flex-1 px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 font-semibold hover:bg-slate-100 dark:hover:bg-slate-700">
                Cancel
            </button>
            <button onclick="generateQuiz()" class="flex-1 px-4 py-2 rounded-lg bg-primary text-white font-semibold hover:bg-primary/90">
                Generate Quiz
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    function showGenerateModal() {
        document.getElementById('generateModal').classList.remove('hidden');
    }
    
    function hideGenerateModal() {
        document.getElementById('generateModal').classList.add('hidden');
    }
    
    function generateQuiz() {
        const generationType = document.querySelector('input[name="generation_type"]:checked').value;
        const quizTitle = document.getElementById('quiz-title').value || 'Auto-Generated Quiz';
        
        fetch('/quizzes/generate/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                generation_type: generationType,
                title: quizTitle
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = `/quizzes/${data.quiz_id}/edit/`;
            } else {
                alert('Error generating quiz: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error generating quiz. Please try again.');
        });
    }
    
    function deleteQuiz(quizId) {
        if (confirm('Are you sure you want to delete this quiz?')) {
            fetch(`/quizzes/${quizId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error deleting quiz');
                }
            });
        }
    }
</script>
{% endblock %}
